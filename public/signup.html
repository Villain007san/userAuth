<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signup - Kasba Shopping App</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Signup - Kasba Shopping App</h1>
    <form id="signupForm">
        <label for="name">Name:</label>
        <input type="text" id="name" required><br><br>

        <label for="email">Email (optional):</label>
        <input type="email" id="email"><br><br>

        <label for="phone">Phone Number (with country code):</label>
        <input type="tel" id="phone" required><br><br>

        <button type="button" id="getOtpBtn">Get OTP</button><br><br>

        <label for="otp" id="otpLabel" style="display:none;">Enter OTP:</label>
        <input type="text" id="otp" required style="display:none;"><br><br>

        <button type="button" id="verifyOtpBtn" style="display:none;">Verify OTP</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Function to send OTP
            async function sendOTP() {
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const phoneNumber = document.getElementById('phone').value;

                if (!name || !phoneNumber) {
                    alert('Name and phone number are required.');
                    return;
                }

                try {
                    const response = await fetch('/api/send-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, email, phoneNumber })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('OTP sent successfully!');
                        document.getElementById('otpLabel').style.display = 'block'; // Show OTP label
                        document.getElementById('otp').style.display = 'block'; // Show OTP input field
                        document.getElementById('verifyOtpBtn').style.display = 'block'; // Show verify button
                    } else {
                        alert(data.msg || 'Failed to send OTP');
                    }

                } catch (error) {
                    console.error('Error sending OTP:', error);
                    alert('Failed to send OTP. Please check your connection.');
                }
            }

            // Function to verify OTP
            async function verifyOTP() {
                const phoneNumber = document.getElementById('phone').value;
                const otp = document.getElementById('otp').value;
                const password = prompt("Please enter your desired password:");

                if (!phoneNumber || !otp || !password) {
                    alert('Phone number, OTP, and password are required.');
                    return;
                }

                try {
                    const response = await fetch('/api/verify-otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ phoneNumber, otp, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.msg || 'OTP verified successfully!');
                        // Redirect to the login page after successful signup
                        window.location.href = '/login.html';
                    } else {
                        alert(data.msg || 'Failed to verify OTP');
                    }

                } catch (error) {
                    console.error('Error verifying OTP:', error);
                    alert('Failed to verify OTP. Please check your connection.');
                }
            }

            // Attach event listeners to buttons after DOM is loaded
            document.getElementById('getOtpBtn').addEventListener('click', sendOTP);
            document.getElementById('verifyOtpBtn').addEventListener('click', verifyOTP);
        });
    </script>
</body>
</html>
